# MCP诊断和故障排除指南

## 🔍 快速诊断

如果AI回复说无法访问外部网站和信息，请按以下步骤排查：

### 1. 检查MCP桥接服务器状态
```bash
# 在 mcp-bridge 目录下检查服务器是否运行
cd simple-ai-copilot/mcp-bridge
npm start
```

看到类似输出表示正常：
```
MCP Bridge Server running on http://localhost:3001
Ready to connect Chrome extension to MCP servers
```

### 2. 检查Chrome扩展连接状态
1. 打开插件设置
2. 查看"MCP桥接服务器"状态指示器
3. 如果显示"未连接"，点击"测试连接"

### 3. 检查MCP服务器连接状态
1. 在设置的"可视化配置"中查看服务器状态
2. 确保你的streamable-mcp-server显示为"已连接"
3. 如果显示"未连接"，尝试重新启用

### 4. 使用调试功能
1. 打开浏览器开发者工具（F12）
2. 进入插件设置（这会触发调试信息输出）
3. 查看控制台中的"MCP调试信息"

## 🔧 常见问题和解决方案

### 问题1：桥接服务器连接失败
**症状**：设置中显示"未连接"
**解决方案**：
```bash
# 1. 确认端口没有被占用
netstat -an | findstr :3001

# 2. 重启桥接服务器
cd simple-ai-copilot/mcp-bridge
npm start

# 3. 检查防火墙设置
```

### 问题2：MCP服务器连接失败
**症状**：服务器状态显示"错误"或"未连接"
**解决方案**：
1. 确认你的streamable MCP服务器在运行
2. 验证URL `http://127.0.0.1:12306/mcp` 可访问
3. 检查服务器日志是否有错误

### 问题3：工具没有被调用
**症状**：AI回复没有使用外部信息
**解决方案**：
1. 使用包含明确关键词的问题，如：
   - "搜索最新的AI新闻"
   - "查找JavaScript教程"
   - "获取当前时间信息"
2. 检查控制台是否有工具调用日志

### 问题4：工具调用失败
**症状**：看到"工具调用失败"错误
**解决方案**：
1. 检查MCP服务器的具体错误信息
2. 验证服务器是否正确实现了MCP协议
3. 检查网络连接和权限

## 📊 调试信息解读

在控制台中查看以下信息：

```javascript
=== MCP调试信息 ===
桥接服务器连接状态: { connected: true, url: "http://localhost:3001" }
已配置的MCP服务器: [...] // 应该包含你的配置
已连接的MCP服务器: [...] // 应该显示已连接的服务器
可用工具: [...] // 应该显示可用的工具列表
==================
```

### 正常状态应该显示：
- `桥接服务器连接状态.connected: true`
- `已连接的MCP服务器` 不为空
- `可用工具` 包含你的服务器提供的工具

## 🧪 测试用例

使用以下消息测试MCP功能：

### 搜索相关测试
```
搜索最新的人工智能新闻
查找JavaScript最佳实践
获取今天的天气信息
```

### 文件操作测试
```
读取README.md文件
列出当前目录的文件
查看package.json的内容
```

### 通用信息测试
```
什么是MCP协议？
介绍一下React框架
告诉我Python的优势
```

## 🔄 完整重置步骤

如果以上方法都不行，尝试完整重置：

1. **停止所有服务**
   ```bash
   # 停止桥接服务器
   Ctrl+C
   
   # 停止你的MCP服务器
   ```

2. **清除扩展数据**
   - 在扩展设置中点击"重置设置"
   - 或在Chrome中删除并重新加载扩展

3. **重新配置**
   ```bash
   # 重启桥接服务器
   cd simple-ai-copilot/mcp-bridge
   npm start
   
   # 重启你的MCP服务器
   ```

4. **重新导入配置**
   ```json
   {
     "mcpServers": {
       "streamable-mcp-server": {
         "type": "streamable-http",
         "url": "http://127.0.0.1:12306/mcp",
         "description": "我的流式MCP服务器"
       }
     }
   }
   ```

## 💡 优化建议

1. **确保服务稳定性**
   - 使用进程管理器（如PM2）运行MCP服务器
   - 配置自动重启

2. **改进工具检测**
   - 使用更明确的关键词
   - 在消息中明确说明需要外部信息

3. **监控连接状态**
   - 定期检查服务器状态
   - 设置健康检查

## 📞 获取更多帮助

如果问题仍然存在，请：
1. 收集控制台日志
2. 记录具体的错误信息
3. 确认MCP服务器的实现细节
4. 检查网络和防火墙配置

记住：MCP工具调用需要所有组件正常工作：浏览器扩展 ↔ 桥接服务器 ↔ MCP服务器